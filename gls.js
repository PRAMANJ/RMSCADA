window.lat=0;window.lng=0;var prof_json,user_json,no_of_profiles=0,no_of_users=0;function getLocation(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(updatePosition);return null}function updatePosition(a){a&&(window.lat=a.coords.latitude,window.lng=a.coords.longitude,lat=window.lat,lng=window.lng)}function currentLocation(){return{lat:window.lat,lng:window.lng}}
var map,cln,lat,lng,infoWindow,mark=[],clients=[],usr=[],ne,sw,names=[],nocl=0,nu=0,labels="123456789abcdefghijklmnopqrstABCDEFGHIJKLMNOPQRSTUVWXYZ",initialize=function(){map=new google.maps.Map(document.getElementById("map-canvas"),{center:{lat:lat,lng:lng},zoom:12});infoWindow=new google.maps.InfoWindow;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){a={lat:a.coords.latitude,lng:a.coords.longitude};infoWindow.open(map);map.setCenter(a)},function(){handleLocationError(!0,
infoWindow,map.getCenter())}):handleLocationError(!1,infoWindow,map.getCenter());var a;google.maps.event.addListener(map,"bounds_changed",function(){a=map.getBounds();ne=a.getNorthEast().toJSON();sw=a.getSouthWest().toJSON()})};window.initialize=initialize;
var redraw=function(a){lat=a.message.lat;lng=a.message.lng;cln=a.message.client;a=-1;var b;b=cln.split("|");if(0<nocl)for(var c=0;c<nocl;c++)if(b[0]==clients[c]){a=c;break}0>a?(a=nocl,nocl++,clients[a]=b[0],usr[a]=b[1],mark[a]=new google.maps.Marker({position:{lat:lat,lng:lng},label:labels[a%labels.length],title:usr[a]+"",map:map})):mark[a].setPosition({lat:lat,lng:lng,alt:0})},pnChannel="map-channel",cmChannel="commands_channel",rsChannel="response_channel",UUID=PubNub.generateUUID(),pubnub=new PubNub({uuid:UUID,
publishKey:publish_key,subscribeKey:subscribe_key,ssl:!0});pubnub.subscribe({channels:[pnChannel,cmChannel,rsChannel]});
pubnub.addListener({status:function(a){"PNConnectedCategory"===a.category&&(console.log("pn connected"),pubnub.publish({channel:"command_channel",message:{msg:"GETPROFILES"}}),console.log("message published"))},message:function(a){if(a.channel==cmChannel){a=a.message.split(" ");var b=0;if("ACKNOWLEDGE"==a[1])console.log("Acknowledge received"),pubnub.publish({channel:rsChannel,message:a[0]+" ACKNOWLEDGE"});else if("LOGIN"==a[1]&&"SUCCESS"!=a[2]&&"FAIL"!=a[2]){for(var c=0;c<no_of_users;c++)if(a[2]==
user_json[c].user&&user_json[c].userpassword==a[3]){for(var b=-1,d=0;c<no_of_profiles;d++)if(user_json[c].userprofile==prof_json[d].profile){b=d;break}pubnub.publish({channel:rsChannel,message:a[0]+" LOGIN SUCCESS "+a[2]+" "+(0<=b?prof_json[b].profileaccess:"  ")});b=1;break}0==b&&pubnub.publish({channel:rsChannel,message:a[0]+" LOGIN FAIL"})}}else a.channel==rsChannel?(a=a.message.split("^"),"GETPROFILES"==a[0]?(a=a[1],pubnub.publish({channel:"command_channel",message:{msg:"GETUSERS"}}),prof_json=
JSON.parse(a),no_of_profiles=prof_json.length):"GETUSERS"==a[0]&&(user_json=JSON.parse(a[1]),no_of_users=user_json.length)):a.channel==pnChannel&&redraw(a)}});
