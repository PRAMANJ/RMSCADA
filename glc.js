window.lat=0;var client=window.lng=0,ne,sw,newlat,newlng;function getLocation(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(updatePosition);return null}function updatePosition(a){a&&(window.lat=a.coords.latitude,window.lng=a.coords.longitude)}
function currentLocation(){if(simulate)return redraw({message:{lat:newlat,lng:newlng}}),{lat:newlat,lng:newlng,client:client+"|"+USER};redraw({message:{lat:window.lat,lng:window.lng}});return{lat:window.lat,lng:window.lng,client:client+"|"+USER}}
var map,nesw,width,height,infoWindow,mark,USER="",PW="",ACCESS="XX",pnChannel="map-channel",cmChannel="commands_channel",rsChannel="response_channel",UUID=PubNub.generateUUID(),pubnub,initialize=function(){map=new google.maps.Map(document.getElementById("map-canvas"),{center:{lat:lat,lng:lng},zoom:12});infoWindow=new google.maps.InfoWindow;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){a={lat:a.coords.latitude,lng:a.coords.longitude};infoWindow.open(map);map.setCenter(a)},
function(){handleLocationError(!0,infoWindow,map.getCenter())}):handleLocationError(!1,infoWindow,map.getCenter());mark=new google.maps.Marker({position:{lat:lat,lng:lng},title:client,map:map});google.maps.event.addListener(map,"bounds_changed",function(){nesw=map.getBounds();ne=nesw.getNorthEast().toJSON();sw=nesw.getSouthWest().toJSON();width=ne.lng-sw.lng;height=ne.lat-sw.lat});setInterval(function(){simulate?(newlat=sw.lat+Math.random()*height,newlng=sw.lng+Math.random()*width):getLocation()},
5E3)};window.initialize=initialize;var redraw=function(a){lat=a.message.lat;lng=a.message.lng;mark.setPosition({lat:lat,lng:lng,alt:0});""==USER?mark.setTitle(client):mark.setTitle(USER)},client=UUID;pubnub=new PubNub({uuid:UUID,publishKey:publish_key,subscribeKey:subscribe_key,ssl:!0});
pubnub.addListener({status:function(a){console.log("Status received",a.category);"PNConnectedCategory"===a.category&&(console.log("PNConnected"),pubnub.publish({channel:cmChannel,message:UUID+" ACKNOWLEDGE"}))},message:function(a){var b=[],b=a.message.split(" ");if(b[0]==UUID)if("ACKNOWLEDGE"==b[1]||"LOGIN"==b[1]&&"FAIL"==b[2]){for(;null==(USER=prompt("User name?")););for(;null==(PW=prompt("Password?")););pubnub.publish({channel:cmChannel,message:UUID+" LOGIN "+USER+" "+PW})}else"LOGIN"==b[1]&&"SUCCESS"==
b[2]&&(ACCESS=b[4],setInterval(function(){pubnub.publish({channel:pnChannel,message:currentLocation()})},5E3))},presence:function(a){}});pubnub.subscribe({channels:[rsChannel]});
